
var Unit=(function(){var ct=0;return function(obj){var s=this;obj=obj||{};s.id=obj.id||ct+'_'+new Date().getTime();ct+=1;if(ct>1000){ct=0;}
s.x=obj.x||-16;s.y=obj.y||-16;s.w=obj.w||32;s.h=obj.h||32;s.hw=16;s.hh=16;s.a=obj.a||0;s.delta=1;s.maxHP=obj.maxHP||20;s.hp=s.maxHP;s.faction=obj.faction||'n';s.s='#ffffff';s.f='#000000';s.i=3;};}
());Unit.prototype.step=function(){var s=this;s.a=_.an(s.a);s.x+=Math.cos(s.a)*s.delta;s.y+=Math.sin(s.a)*s.delta;};var Shot=function(obj){var s=this
Unit.call(s,obj);s.delta=6;s.life=100;s.dam=1;s.maxHP=50;s.hp=s.maxHP;s.w=4;s.h=4;s.fromShip=obj.fromShip||{};};Shot.prototype=new Unit();var Ship=function(obj){var s=this;Unit.call(s,obj);s.delta=obj.delta||3;s.shots=obj.shots||false;s.lastFire=new Date();s.fireRate=obj.firRate||100;s.target=false;s.dtt=0;s.aDir=0;s.adt=0;s.toTarget=0;s.turnPer=0;s.maxTurn=Math.PI/180*10;s.aDelta=0;};var p=Ship.prototype=new Unit();p.findTarget=function(eShips){this.target=false;if(eShips.units.length>0){this.target=eShips.units[Math.floor(_.r(eShips.units.length))]}};p.updateTarget=function(){var toTarget,s=this;if(s.target){s.toTarget=Math.atan2(s.target.y-s.y,s.target.x-s.x);s.dtt=_.d(s.x+s.w,s.y,s.target.x,s.target.y);s.adt=_.ad(s.a,s.toTarget);s.turnPer=s.adt/Math.PI;s.aDelta=s.turnPer*s.maxTurn;}};p.followTarget=function(){var s=this;s.aDir=_.asd(s.a,s.toTarget);if(s.aDir===1){s.a+=s.aDelta;}
if(s.aDir===-1){s.a-=s.aDelta;}};p.shoot=function(){var now=new Date(),s=this;if(s.shots){if(now-s.lastFire>=s.fireRate){this.shots.add(new Shot({x:s.x+s.w/2,y:s.y+s.h/2,a:s.a,fromShip:s}));s.lastFire=now;}}};var UnitCollection=function(obj){obj=obj||{};this.units=obj.units||[];this.max=10;};p=UnitCollection.prototype;p.collidesWith=function(unit){var i=this.units.length;while(i--){if(_.b(this.units[i],unit)){return this.units[i];}}
return false;};p.purgeDead=function(){var i=this.units.length;while(i--){if(this.units[i].hp<=0){this.units.splice(i,1);}}};p.add=function(unit){unit=unit||new Unit();if(this.units.length<this.max){this.units.push(unit);}};var ShotCollection=function(obj){obj=obj||{};UnitCollection.call(this,obj);this.max=50;};p=ShotCollection.prototype=new UnitCollection();p.step=function(fe){var i=this.units.length,sh;fe=fe||function(){};while(i--){sh=this.units[i];sh.step();sh.hp-=1;if(sh.hp<0){sh.hp=0;}
fe(sh);}
this.purgeDead();};var ShipCollection=function(obj){var s=this;obj=obj||{};UnitCollection.call(s,obj);s.faction=obj.faction||'n';s.ai=obj.ai||false;s.enemys=obj.enemys||{units:[],max:0};s.shots=new ShotCollection();};p=ShipCollection.prototype=new UnitCollection();p.addShip=function(obj){obj=obj||{}
obj.faction=this.faction;obj.shots=this.shots;this.add(new Ship(obj));};p.update=function(obj){var s=this;if(s.ai){s.units.forEach(function(ship){var d;if(!ship.target){ship.findTarget(s.enemys);}
if(ship.target){ship.updateTarget();if(ship.dtt>200){ship.followTarget();}}
ship.step();});}
s.shots.step(function(sh){var es=s.enemys,i=es.units.length,e;if(i>0){while(i--){e=es.units[i];if(_.b(sh,e)){sh.hp=0;e.hp-=sh.dam;if(e.hp<=0){sh.fromShip.target=false;}}}}});s.purgeDead();};