
var Unit=(function(){var ct=0;return function(obj){obj=obj||{};this.id=obj.id||ct+'_'+new Date().getTime();ct+=1;if(ct>1000){ct=0;}
this.x=obj.x||-16;this.y=obj.y||-16;this.w=obj.w||32;this.h=obj.h||32;this.hw=16;this.hh=16;this.a=obj.a||0;this.delta=1;this.maxHP=obj.maxHP||20;this.hp=this.maxHP;this.faction=obj.faction||'n';this.s='#ffffff';this.f='#000000';this.i=3;};}
());Unit.prototype.step=function(){this.a=_.an(this.a);this.x+=Math.cos(this.a)*this.delta;this.y+=Math.sin(this.a)*this.delta;};var Shot=function(obj){Unit.call(this,obj);this.delta=6;this.life=100;this.dam=1;this.maxHP=50;this.hp=this.maxHP;this.w=4;this.h=4;this.fromShip=obj.fromShip||{};};Shot.prototype=new Unit();var Ship=function(obj){Unit.call(this,obj);this.delta=obj.delta||3;this.shots=obj.shots||false;this.lastFire=new Date();this.fireRate=obj.firRate||100;this.target=false;this.dtt=0;this.aDir=0;this.adt=0;this.toTarget=0;this.turnPer=0;this.maxTurn=Math.PI/180*10;this.aDelta=0;};Ship.prototype=new Unit();Ship.prototype.findTarget=function(eShips){this.target=false;if(eShips.units.length>0){this.target=eShips.units[Math.floor(_.r(eShips.units.length))]}};Ship.prototype.updateTarget=function(){var toTarget;if(this.target){this.toTarget=Math.atan2(this.target.y-this.y,this.target.x-this.x);this.dtt=_.d(this.x+this.w,this.y,this.target.x,this.target.y);this.adt=_.ad(this.a,this.toTarget);this.turnPer=this.adt/Math.PI;this.aDelta=this.turnPer*this.maxTurn;}};Ship.prototype.followTarget=function(){this.aDir=_.asd(this.a,this.toTarget);if(this.aDir===1){this.a+=this.aDelta;}
if(this.aDir===-1){this.a-=this.aDelta;}};Ship.prototype.shoot=function(){var now=new Date();if(this.shots){if(now-this.lastFire>=this.fireRate){this.shots.add(new Shot({x:this.x+this.w/2,y:this.y+this.h/2,a:this.a,fromShip:this}));this.lastFire=now;}}};var UnitCollection=function(obj){obj=obj||{};this.units=obj.units||[];this.max=10;};UnitCollection.prototype.collidesWith=function(unit){var i=this.units.length;while(i--){if(_.b(this.units[i],unit)){return this.units[i];}}
return false;};UnitCollection.prototype.purgeDead=function(){var i=this.units.length;while(i--){if(this.units[i].hp<=0){this.units.splice(i,1);}}};UnitCollection.prototype.add=function(unit){unit=unit||new Unit();if(this.units.length<this.max){this.units.push(unit);}};var ShotCollection=function(obj){obj=obj||{};UnitCollection.call(this,obj);this.max=50;};ShotCollection.prototype=new UnitCollection();ShotCollection.prototype.step=function(fe){var i=this.units.length,sh;fe=fe||function(){};while(i--){sh=this.units[i];sh.step();sh.hp-=1;if(sh.hp<0){sh.hp=0;}
fe(sh);}
this.purgeDead();};var ShipCollection=function(obj){obj=obj||{};UnitCollection.call(this,obj);this.faction=obj.faction||'n';this.ai=obj.ai||false;this.enemys=obj.enemys||{units:[],max:0};this.shots=new ShotCollection();};ShipCollection.prototype=new UnitCollection();ShipCollection.prototype.addShip=function(obj){obj=obj||{}
obj.faction=this.faction;obj.shots=this.shots;this.add(new Ship(obj));};ShipCollection.prototype.update=function(obj){var self=this;if(this.ai){this.units.forEach(function(ship){var d;if(!ship.target){ship.findTarget(self.enemys);}
if(ship.target){ship.updateTarget();if(ship.dtt>200){ship.followTarget();}}
ship.step();});}
this.shots.step(function(sh){var es=self.enemys,i=es.units.length,e;if(i>0){while(i--){e=es.units[i];if(_.b(sh,e)){sh.hp=0;e.hp-=sh.dam;if(e.hp<=0){sh.fromShip.target=false;}}}}});this.purgeDead();};